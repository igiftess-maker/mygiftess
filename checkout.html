<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Giftess</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .checkout-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .checkout-form {
            background: var(--bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .checkout-summary {
            background: var(--bg-gray);
            border-radius: var(--radius);
            padding: 2rem;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .summary-item-info {
            flex: 1;
        }

        .summary-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border);
        }

        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .checkout-summary {
                position: static;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo">giftess</a>
            <div style="font-size: 1.2rem; color: var(--primary);">Checkout</div>
        </div>
    </header>

    <div class="checkout-container">
        <!-- Checkout Form -->
        <div class="checkout-form">
            <h2 style="margin-bottom: 2rem;">Delivery Information</h2>

            <form id="checkout-form">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" id="customer-name" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="customer-email" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" id="customer-phone" class="form-input" placeholder="10 digit mobile number" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Delivery Address *</label>
                    <textarea id="delivery-address" class="form-input" rows="3" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Pincode *</label>
                    <input type="text" id="pincode" class="form-input" placeholder="6 digit pincode" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea id="special-notes" class="form-input" rows="2" placeholder="Any special requests or gift message..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Promo Code (Optional)</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="promo-code" class="form-input" placeholder="Enter promo code">
                        <button type="button" class="btn btn-outline" onclick="applyPromoCode()">Apply</button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    Place Order via WhatsApp
                </button>

                <p style="text-align: center; color: var(--text-light); margin-top: 1rem; font-size: 0.9rem;">
                    You will be redirected to WhatsApp to confirm your order
                </p>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="checkout-summary">
            <h3 style="margin-bottom: 1.5rem;">Order Summary</h3>

            <div id="summary-items">
                <!-- Cart items will be loaded here -->
            </div>

            <div class="summary-total">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Subtotal:</span>
                    <span id="summary-subtotal">₹0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Shipping:</span>
                    <span id="summary-shipping">₹0</span>
                </div>
                <div id="discount-row" style="display: none; justify-content: space-between; margin-bottom: 0.5rem; color: var(--success);">
                    <span>Discount:</span>
                    <span id="summary-discount">-₹0</span>
                </div>
                <div id="tax-row" style="display: none; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Tax:</span>
                    <span id="summary-tax">₹0</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: bold; color: var(--primary); margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                    <span>Total:</span>
                    <span id="summary-total">₹0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        let storeSettings = null;
        let appliedDiscount = 0;

        // Load store settings
        async function loadStoreSettings() {
            try {
                const { data, error } = await supabase
                    .from('store_settings')
                    .select('*')
                    .eq('id', 1)
                    .single();

                if (error) throw error;
                storeSettings = data;
            } catch (error) {
                console.error('Error loading settings:', error);
                storeSettings = {
                    wa_number: '916002698296',
                    shipping_fee: 100,
                    free_shipping_min: 999,
                    tax_enabled: false,
                    tax_percent: 0,
                    promo_codes: []
                };
            }
        }

        // Render order summary
        function renderSummary() {
            const cart = Cart.get();

            if (cart.length === 0) {
                window.location.href = '/';
                return;
            }

            const itemsContainer = document.getElementById('summary-items');
            itemsContainer.innerHTML = cart.map(item => `
                <div class="summary-item">
                    <img src="${item.photo || 'https://via.placeholder.com/50'}" alt="${item.name}">
                    <div class="summary-item-info">
                        <div style="font-weight: 500;">${item.name}</div>
                        <div style="color: var(--text-light); font-size: 0.9rem;">Qty: ${item.quantity}</div>
                    </div>
                    <div style="font-weight: 600;">${formatPrice(item.price * item.quantity)}</div>
                </div>
            `).join('');

            updateSummary();
        }

        // Update summary calculations
        function updateSummary() {
            const subtotal = Cart.getTotal();
            const shipping = subtotal >= storeSettings.free_shipping_min ? 0 : storeSettings.shipping_fee;
            const tax = storeSettings.tax_enabled ? Math.round(subtotal * storeSettings.tax_percent / 100) : 0;
            const total = subtotal + shipping + tax - appliedDiscount;

            document.getElementById('summary-subtotal').textContent = formatPrice(subtotal);
            document.getElementById('summary-shipping').textContent = shipping === 0 ? 'FREE' : formatPrice(shipping);
            document.getElementById('summary-total').textContent = formatPrice(total);

            if (tax > 0) {
                document.getElementById('tax-row').style.display = 'flex';
                document.getElementById('summary-tax').textContent = formatPrice(tax);
            }

            if (appliedDiscount > 0) {
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('summary-discount').textContent = '-' + formatPrice(appliedDiscount);
            }
        }

        // Apply promo code
        window.applyPromoCode = function() {
            const code = document.getElementById('promo-code').value.trim().toUpperCase();

            if (!code) {
                showToast('Please enter a promo code', 'error');
                return;
            }

            const promoCodes = storeSettings.promo_codes || [];
            const promo = promoCodes.find(p => p.code.toUpperCase() === code && p.active);

            if (!promo) {
                showToast('Invalid promo code', 'error');
                return;
            }

            const subtotal = Cart.getTotal();

            if (promo.min_order && subtotal < promo.min_order) {
                showToast(`Minimum order of ${formatPrice(promo.min_order)} required`, 'error');
                return;
            }

            if (promo.type === 'percentage') {
                appliedDiscount = Math.round(subtotal * promo.value / 100);
            } else {
                appliedDiscount = promo.value;
            }

            showToast(`Promo code applied! You saved ${formatPrice(appliedDiscount)}`, 'success');
            updateSummary();
        };

        // Handle checkout
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('customer-name').value;
            const email = document.getElementById('customer-email').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('delivery-address').value;
            const pincode = document.getElementById('pincode').value;
            const notes = document.getElementById('special-notes').value;

            // Validate
            if (!isValidPhone(phone)) {
                showToast('Please enter a valid 10-digit phone number', 'error');
                return;
            }

            if (!isValidPincode(pincode)) {
                showToast('Please enter a valid 6-digit pincode', 'error');
                return;
            }

            if (email && !isValidEmail(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            showLoading(btn);

            try {
                const cart = Cart.get();
                const subtotal = Cart.getTotal();
                const shipping = subtotal >= storeSettings.free_shipping_min ? 0 : storeSettings.shipping_fee;
                const tax = storeSettings.tax_enabled ? Math.round(subtotal * storeSettings.tax_percent / 100) : 0;
                const total = subtotal + shipping + tax - appliedDiscount;

                const orderData = {
                    order_id: generateOrderId(),
                    user_id: (await getCurrentUser())?.id || null,
                    customer_name: name,
                    customer_email: email || null,
                    customer_phone: phone,
                    delivery_address: address,
                    pincode: pincode,
                    items: cart,
                    subtotal: subtotal,
                    shipping_fee: shipping,
                    discount: appliedDiscount,
                    tax_amount: tax,
                    total: total,
                    status: 'pending',
                    notes: notes || null
                };

                // Save order to database
                const { error } = await supabase
                    .from('orders')
                    .insert([orderData]);

                if (error) throw error;

                // Clear cart
                Cart.clear();

                // Redirect to WhatsApp
                const waMessage = formatWhatsAppMessage(orderData);
                const waUrl = `https://wa.me/${storeSettings.wa_number}?text=${waMessage}`;
                window.open(waUrl, '_blank');

                // Show success and redirect
                showToast('Order placed successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);

            } catch (error) {
                console.error('Checkout error:', error);
                showToast('Failed to place order. Please try again.', 'error');
            } finally {
                hideLoading(btn);
            }
        });

        // Initialize
        async function init() {
            await loadStoreSettings();
            renderSummary();
        }

        init();
    </script>
</body>
</html>
